name: KOD Build

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux-x64:
    name: Build Linux x86_64
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libclang-dev cmake
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88.0"
          targets: wasm32-unknown-unknown
          components: rust-src
          
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Build
        run: cargo build --release
        
      - name: Package
        run: |
          mkdir -p release
          cp target/release/kod-node release/
          cd release && tar -czvf kod-node-linux-x64.tar.gz kod-node
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kod-node-linux-x64
          path: release/kod-node-linux-x64.tar.gz

  build-macos-arm64:
    name: Build macOS ARM64 (Apple Silicon)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: brew install protobuf cmake
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88.0"
          targets: wasm32-unknown-unknown
          components: rust-src
          
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Build
        run: cargo build --release
        
      - name: Package
        run: |
          mkdir -p release
          cp target/release/kod-node release/
          cd release && tar -czvf kod-node-macos-arm64.tar.gz kod-node
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kod-node-macos-arm64
          path: release/kod-node-macos-arm64.tar.gz

  build-macos-x64:
    name: Build macOS x86_64 (Intel)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: brew install protobuf cmake
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88.0"
          targets: wasm32-unknown-unknown
          components: rust-src
          
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Build
        run: cargo build --release
        
      - name: Package
        run: |
          mkdir -p release
          cp target/release/kod-node release/
          cd release && tar -czvf kod-node-macos-x64.tar.gz kod-node
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kod-node-macos-x64
          path: release/kod-node-macos-x64.tar.gz

  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install protobuf
        run: choco install protoc -y
        
      - name: Install LLVM
        run: choco install llvm -y
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88.0"
          targets: wasm32-unknown-unknown
          components: rust-src
          
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Build
        run: cargo build --release
        env:
          LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
          
      - name: Package
        run: |
          mkdir release
          copy target\release\kod-node.exe release\
          Compress-Archive -Path release\kod-node.exe -DestinationPath release\kod-node-windows-x64.zip
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kod-node-windows-x64
          path: release/kod-node-windows-x64.zip

  release:
    name: Create Release
    needs: [build-linux-x64, build-macos-arm64, build-macos-x64, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/kod-node-linux-x64/kod-node-linux-x64.tar.gz
            artifacts/kod-node-macos-arm64/kod-node-macos-arm64.tar.gz
            artifacts/kod-node-macos-x64/kod-node-macos-x64.tar.gz
            artifacts/kod-node-windows-x64/kod-node-windows-x64.zip
          body: |
            ## KOD Chain Node Release
            
            ### Download for your platform:
            - **Linux x86_64**: `kod-node-linux-x64.tar.gz`
            - **macOS Apple Silicon (M1/M2/M3/M4)**: `kod-node-macos-arm64.tar.gz`
            - **macOS Intel**: `kod-node-macos-x64.tar.gz`
            - **Windows**: `kod-node-windows-x64.zip`
            
            ### Quick Start
            ```bash
            # Extract
            tar -xzf kod-node-*.tar.gz  # Linux/macOS
            # or unzip for Windows
            
            # Start mining
            ./kod-node --mine --reward-address YOUR_SS58_ADDRESS
            ```
            
            See [kod.services](https://kod.services) for full documentation.
